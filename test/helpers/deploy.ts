/**
 * @description Token deployment utilities for testing
 * Contains helpers for deploying ERC20Issuance tokens on devnet
 */

import type { Address, Chain, Hex, PublicClient, Transport } from 'viem'

import ERC20Issuance_v1 from '../../src/abis/ERC20Issuance_v1'
import type { PopWalletClient } from '../../src/types'

// ERC20Issuance_v1 bytecode from forge output
// Constructor: (string name_, string symbol_, uint8 decimals_, uint256 maxSupply_)
const ERC20_ISSUANCE_BYTECODE =
  '0x60c060405234801562000010575f80fd5b5060405162000f7d38038062000f7d8339810160408190526200003391620001db565b338185856003620000458382620002ea565b506004620000548282620002ea565b505050805f036200007f5760405163392e1e2760e01b81525f60048201526024015b60405180910390fd5b6080526001600160a01b038116620000ad57604051631e4fbdf760e01b81525f600482015260240162000076565b620000b881620000c9565b505060ff1660a05250620003b69050565b600580546001600160a01b038381166001600160a01b0319831681179093556040519116919082907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0905f90a35050565b634e487b7160e01b5f52604160045260245ffd5b5f82601f8301126200013e575f80fd5b81516001600160401b03808211156200015b576200015b6200011a565b604051601f8301601f19908116603f011681019082821181831017156200018657620001866200011a565b8160405283815260209250866020858801011115620001a3575f80fd5b5f91505b83821015620001c65785820183015181830184015290820190620001a7565b5f602085830101528094505050505092915050565b5f805f8060808587031215620001ef575f80fd5b84516001600160401b038082111562000206575f80fd5b62000214888389016200012e565b955060208701519150808211156200022a575f80fd5b5062000239878288016200012e565b935050604085015160ff8116811462000250575f80fd5b6060959095015193969295505050565b600181811c908216806200027557607f821691505b6020821081036200029457634e487b7160e01b5f52602260045260245ffd5b50919050565b601f821115620002e557805f5260205f20601f840160051c81016020851015620002c15750805b601f840160051c820191505b81811015620002e2575f8155600101620002cd565b50505b505050565b81516001600160401b038111156200030657620003066200011a565b6200031e8162000317845462000260565b846200029a565b602080601f83116001811462000354575f84156200033c5750858301515b5f19600386901b1c1916600185901b178555620003ae565b5f85815260208120601f198616915b82811015620003845788860151825594840194600190910190840162000363565b5085821015620003a257878501515f19600388901b60f8161c191681555b505060018460011b0185555b505050505050565b60805160a051610b9e620003df5f395f6101a001525f81816101cc01526108470152610b9e5ff3fe608060405234801561000f575f80fd5b506004361061012f575f3560e01c8063715018a6116100ad578063a9059cbb1161007d578063dd62ed3e11610063578063dd62ed3e146102b3578063dd8aaa4f146102eb578063f2fde38b146102fe575f80fd5b8063a9059cbb1461028d578063cf456ae7146102a0575f80fd5b8063715018a61461024f5780638da5cb5b1461025757806395d89b41146102725780639dc29fac1461027a575f80fd5b8063313ce5671161010257806340c10f19116100e857806340c10f19146101f0578063423afa661461020557806370a0823114610227575f80fd5b8063313ce56714610199578063355274ea146101ca575f80fd5b806306fdde0314610133578063095ea7b31461015157806318160ddd1461017457806323b872dd14610186575b5f80fd5b61013b610311565b60405161014891906109bf565b60405180910390f35b61016461015f366004610a26565b6103a1565b6040519015158152602001610148565b6002545b604051908152602001610148565b610164610194366004610a4e565b6103ba565b60405160ff7f0000000000000000000000000000000000000000000000000000000000000000168152602001610148565b7f0000000000000000000000000000000000000000000000000000000000000000610178565b6102036101fe366004610a26565b6103dd565b005b610164610213366004610a87565b60066020525f908152604090205460ff1681565b610178610235366004610a87565b6001600160a01b03165f9081526020819052604090205490565b61020361041a565b6005546040516001600160a01b039091168152602001610148565b61013b61042d565b610203610288366004610a26565b61043c565b61016461029b366004610a26565b610475565b6102036102ae366004610aa7565b610482565b6101786102c1366004610ae0565b6001600160a01b039182165f90815260016020908152604080832093909416825291909152205490565b6102036102f9366004610a4e565b610494565b61020361030c366004610a87565b6104d3565b60606003805461032090610b11565b80601f016020809104026020016040519081016040528092919081815260200182805461034c90610b11565b80156103975780601f1061036e57610100808354040283529160200191610397565b820191905f5260205f20905b81548152906001019060200180831161037a57829003601f168201915b5050505050905090565b5f336103ae818585610515565b60019150505b92915050565b5f336103c7858285610522565b6103d285858561059e565b506001949350505050565b335f9081526006602052604090205460ff1661040c57604051634199e25360e11b815260040160405180910390fd5b61041682826105fb565b5050565b61042261062f565b61042b5f61065c565b565b60606004805461032090610b11565b335f9081526006602052604090205460ff1661046b57604051634199e25360e11b815260040160405180910390fd5b61041682826106c5565b5f336103ae81858561059e565b61048a61062f565b61041682826106f9565b335f9081526006602052604090205460ff166104c357604051634199e25360e11b815260040160405180910390fd5b6104ce838383610522565b505050565b6104db61062f565b6001600160a01b03811661050957604051631e4fbdf760e01b81525f60048201526024015b60405180910390fd5b6105128161065c565b50565b6104ce8383836001610757565b6001600160a01b038381165f908152600160209081526040808320938616835292905220545f19811015610598578181101561058a57604051637dc7a0d960e11b81526001600160a01b03841660048201526024810182905260448101839052606401610500565b61059884848484035f610757565b50505050565b6001600160a01b0383166105c757604051634b637e8f60e11b81525f6004820152602401610500565b6001600160a01b0382166105f05760405163ec442f0560e01b81525f6004820152602401610500565b6104ce838383610829565b6001600160a01b0382166106245760405163ec442f0560e01b81525f6004820152602401610500565b6104165f8383610829565b6005546001600160a01b0316331461042b5760405163118cdaa760e01b8152336004820152602401610500565b600580546001600160a01b038381167fffffffffffffffffffffffff0000000000000000000000000000000000000000831681179093556040519116919082907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0905f90a35050565b6001600160a01b0382166106ee57604051634b637e8f60e11b81525f6004820152602401610500565b610416825f83610829565b6001600160a01b0382165f81815260066020908152604091829020805460ff191685151590811790915591519182527f583b0aa0e528532caf4b907c11d7a8158a122fe2a6fb80cd9b09776ebea8d92d910160405180910390a25050565b6001600160a01b0384166107805760405163e602df0560e01b81525f6004820152602401610500565b6001600160a01b0383166107a957604051634a1406b160e11b81525f6004820152602401610500565b6001600160a01b038085165f908152600160209081526040808320938716835292905220829055801561059857826001600160a01b0316846001600160a01b03167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b9258460405161081b91815260200190565b60405180910390a350505050565b610834838383610899565b6001600160a01b0383166104ce576002547f000000000000000000000000000000000000000000000000000000000000000090818111156108925760405163279e7e1560e21b81046004810182905260248101839052604401610500565b5050505050565b6001600160a01b0383166108c3578060025f8282546108b89190610b49565b909155506109339050565b6001600160a01b0383165f90815260208190526040902054818110156109155760405163391434e360e21b81526001600160a01b03851660048201526024810182905260448101839052606401610500565b6001600160a01b0384165f9081526020819052604090209082900390555b6001600160a01b03821661094f5760028054829003905561096d565b6001600160a01b0382165f9081526020819052604090208054820190555b816001600160a01b0316836001600160a01b03167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef836040516109b291815260200190565b60405180910390a3505050565b5f602080835283518060208501525f5b818110156109eb578581018301518582016040015282016109cf565b505f604082860101526040601f19601f8301168501019250505092915050565b80356001600160a01b0381168114610a21575f80fd5b919050565b5f8060408385031215610a37575f80fd5b610a4083610a0b565b946020939093013593505050565b5f805f60608486031215610a60575f80fd5b610a6984610a0b565b9250610a7760208501610a0b565b9150604084013590509250925092565b5f60208284031215610a97575f80fd5b610aa082610a0b565b9392505050565b5f8060408385031215610ab8575f80fd5b610ac183610a0b565b915060208301358015158114610ad5575f80fd5b809150509250929050565b5f8060408385031215610af1575f80fd5b610afa83610a0b565b9150610b0860208401610a0b565b90509250929050565b600181811c90821680610b2557607f821691505b602082108103610b4357634e487b7160e01b5f52602260045260245ffd5b50919050565b808201808211156103b457634e487b7160e01b5f52601160045260245ffdfea26469706673582212207bbc7b21e3dbb7093dde2c049badabca2bbd66f4465a8de060fdedac88b29cd364736f6c63430008170033' as Hex

/**
 * Token configuration for deployment
 */
export interface TokenConfig {
  name: string
  symbol: string
  decimals: number
  maxSupply: bigint
}

/**
 * Default issuance token configuration
 */
export const DEFAULT_ISSUANCE_TOKEN_CONFIG: TokenConfig = {
  name: 'Test Floor Token',
  symbol: 'TFT',
  decimals: 18,
  maxSupply: BigInt(1_000_000_000e18), // 1B tokens
}

/**
 * Default collateral token configuration (USDC-like)
 */
export const DEFAULT_COLLATERAL_TOKEN_CONFIG: TokenConfig = {
  name: 'Test USDC',
  symbol: 'TUSDC',
  decimals: 6,
  maxSupply: BigInt(1_000_000_000e6), // 1B tokens
}

/**
 * Deploy an ERC20Issuance_v1 token
 * @returns The deployed token address
 */
export async function deployERC20Issuance(
  walletClient: PopWalletClient,
  publicClient: PublicClient<Transport, Chain>,
  config: TokenConfig = DEFAULT_ISSUANCE_TOKEN_CONFIG
): Promise<Address> {
  const { name, symbol, decimals, maxSupply } = config

  // Deploy the token
  const hash = await walletClient.deployContract({
    abi: ERC20Issuance_v1,
    bytecode: ERC20_ISSUANCE_BYTECODE,
    args: [name, symbol, decimals, maxSupply],
  })

  // Wait for deployment
  const receipt = await publicClient.waitForTransactionReceipt({ hash })

  if (!receipt.contractAddress) {
    throw new Error('Token deployment failed - no contract address in receipt')
  }

  return receipt.contractAddress
}

/**
 * Deploy both issuance and collateral tokens for testing
 * Deploys sequentially to avoid nonce conflicts
 */
export async function deployTestTokens(
  walletClient: PopWalletClient,
  publicClient: PublicClient<Transport, Chain>,
  options?: {
    issuance?: Partial<TokenConfig>
    collateral?: Partial<TokenConfig>
  }
): Promise<{ issuanceToken: Address; collateralToken: Address }> {
  const issuanceConfig = {
    ...DEFAULT_ISSUANCE_TOKEN_CONFIG,
    ...options?.issuance,
  }
  const collateralConfig = {
    ...DEFAULT_COLLATERAL_TOKEN_CONFIG,
    ...options?.collateral,
  }

  // Deploy sequentially to avoid nonce conflicts with remote devnet
  const issuanceToken = await deployERC20Issuance(walletClient, publicClient, issuanceConfig)
  const collateralToken = await deployERC20Issuance(walletClient, publicClient, collateralConfig)

  return { issuanceToken, collateralToken }
}
